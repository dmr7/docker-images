#!/bin/bash

set -eo pipefail

main() {
  local source_tree="$1"
  local output_path="$2"
  local tag=""

  if [[ -z "$source_tree" ]]; then
    echo "usage: build-slug <source-tree> [<output-path>]" >&2
    exit 1
  fi

  buildpack-build "$source_tree" "$image_tag"
  docker run -a stdout -a stderr "$image_tag" /bin/bash -c "/bin/herokuish slug generate >&2 && /bin/herokuish slug export" > "${output_path:-/dev/stdout}"
}

finish() {
  docker rmi -f "$image_tag" || true
}

image_tag=$(uuidgen | tr '[:upper:]' '[:lower:]')
trap finish EXIT
main "$@"
