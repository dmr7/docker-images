#!/bin/bash

set -eo pipefail

main() {
  local docker_opts slug cmd

  while [[ -n "$1" && "$1" != "--" ]]; do
    docker_opts="$docker_opts $1"
    shift
  done

  [[ "$1" == "--" ]] && shift
  if [[ -z "$@" ]]; then
    set -- $docker_opts
    unset docker_opts
  fi

  slug="$1"
  shift || true

  if [[ -z "$slug" || -z "$@" ]]; then
    echo "usage: run-slug [<docker-opts> --] <slug-file> <command>" >&2
    exit 1
  fi

  image-from-slug "$slug" "$image_tag" > /dev/null
  docker run --rm -a stdout -a stderr $docker_opts "$image_tag" $@
}

finish() {
  docker rmi -f "$image_tag" > /dev/null || true
}

image_tag=$(uuidgen | tr '[:upper:]' '[:lower:]')
trap finish EXIT
main "$@"
